(()=>{const r=new Set($('link[href*=".css"]').map((e,o)=>$(o).attr("href")).get()),i=new Set($('script[src*=".js"]').map((e,o)=>$(o).attr("src")).get()),o=()=>{var e=(new Date).getTime();return window.pjaxSerialNumber=e,console.log("sn = "+e),e},e=$(".section .container > .tips"),n=$(".actions>.bullet-screen"),c=()=>{"/"===location.pathname?e.removeClass("is-hidden-all"):e.addClass("is-hidden-all"),0===$("halo-comment[bullet-screen]").length?n.addClass("is-hidden-all"):n.removeClass("is-hidden-all")},d=(o,n,t)=>{if(n>=o.length)t&&t();else{let e=$(o[n]).attr("src");i.has(e)?d(o,n+1,t):(console.log((t?"同步":"异步")+"顺序加载js "+e),Utils.cachedScript(e).done(function(){console.log((t?"同步":"异步")+"顺序加载js完成 "+e),i.add(e),window.DProgress&&DProgress.inc(),d(o,n+1,t)}).fail(function(){console.log((t?"同步":"异步")+"顺序加载js失败 "+e),d(o,n+1,t)}))}};$(document).on("click","a[target!=_blank][href]:not(data-not-pjax)",e=>{$.pjax.click(e,".column-main",{scrollTo:"/"!==e.currentTarget.pathname&&0!==$(".banner").length?window.innerHeight/4:0,fragment:".column-main",serialNumber:o(),timeout:8e3})}),$(document).on("submit","form[data-pjax]",function(e){$.pjax.submit(e,".column-main",{scrollTo:0,fragment:".column-main",serialNumber:o(),timeout:8e3})}),$(document).on("pjax:click",function(e,o){console.log("------------------------"),console.log("pjax:click sn = "+o.serialNumber)}),$(document).on("pjax:beforeSend",function(e,o,n){console.log("pjax:beforeSend sn = "+n.serialNumber),$("html").addClass("pjax-loading")}),$(document).on("pjax:start",function(e,o,n){console.log("pjax:start sn = "+n.serialNumber),window.DProgress&&DProgress.start(),$(".pjax-close").remove()}),$(document).on("pjax:send",function(e,o,n){console.log("pjax:send sn = "+n.serialNumber)}),$(document).on("pjax:clicked",function(e,o){console.log("pjax:clicked sn = "+o.serialNumber)}),$(document).on("pjax:beforeReplace",function(e,o,n){console.log("pjax:beforeReplace sn = "+n.serialNumber),$(".navbar-nav .current,.panel-side-menu .current").removeClass("current"),commonContext.initNavbar(),0<$("html.disable-scroll").length&&$(".navbar-mask").trigger("click")}),$(document).on("pjax:success",async function(e,o,n,t,a){a=a.serialNumber;if(console.log("pjax:success sn = "+a),window.pjaxSerialNumber===a){commonContext.initGallery(),commonContext.initTocAndNotice(),c(),$("html").removeClass("pjax-loading");const s=$($.parseHTML(o,document,!0)),l=$("head");l.find("meta").remove(),l.append(s.filter("meta")),s.filter("link[data-pjax]").each(function(){let e=$(this).attr("href");r.has(e)||(l.append($(this)),console.log("加载css "+$(this).attr("href")),this.onload=function(){r.add(e),window.DProgress&&DProgress.inc(),console.log("加载css完成 "+$(this).attr("href"))})});let e=s.filter("script[data-pjax]");if(0<e.length){e.filter("[async]").each(function(){let e=$(this).attr("src");i.has(e)||(console.log("异步无序加载js "+e),Utils.cachedScript(e).done(function(){console.log("异步无序js完成 "+e),window.DProgress&&DProgress.inc(),i.add(e)}).fail(function(){console.log("异步无序js失败 "+e)}))}),new Promise(()=>{d(e.filter("[defer]"),0)});let o=e.filter(":not([async]):not([defer])");0<o.length&&await new Promise(e=>{d(o,0,e)})}console.log("全部处理完成"),window.pjaxSerialNumber===a&&(window.journalPjax&&window.journalPjax(a),window.postPjax&&window.postPjax(a),window.photoPjax&&window.photoPjax(a),commonContext.loadMaintain(),window.DProgress)&&DProgress.done()}}),$(document).on("pjax:timeout",function(e,o,n){console.log("pjax:timeout sn = "+n.serialNumber)}),$(document).on("pjax:error",function(e,o,n,t,a){console.log(`pjax:error sn = ${a.serialNumber} error `+t)}),$(document).on("pjax:complete",function(e,o,n,t){console.log("pjax:complete sn = "+t.serialNumber)}),$(document).on("pjax:end",function(e,o,n){console.log("pjax:end sn = "+n.serialNumber),null==o&&(commonContext.initTocAndNotice(),c(),window.DProgress&&DProgress.done(),$("html").removeClass("pjax-loading"))}),$(document).on("pjax:popstate",function(){console.log("pjax:popstate")})})();